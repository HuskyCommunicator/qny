# AI 角色扮演系统 - 架构设计文档

## 📋 项目概述

### 项目简介
AI角色扮演系统是一个基于FastAPI + Vue.js的智能对话平台，支持多角色扮演、语音交互、知识增强等功能。系统采用前后端分离架构，集成多种AI服务，为用户提供沉浸式的角色扮演体验。

### 技术选型
- **后端**: FastAPI + SQLAlchemy + Pydantic
- **前端**: Vue.js 3 + Element Plus + Pinia
- **数据库**: MySQL + Redis
- **AI服务**: 通义千问 + 百度语音
- **存储**: 阿里云OSS
- **部署**: Docker + Nginx

## 🏗️ 系统架构

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue.js)  │    │   后端 (FastAPI) │    │   外部服务      │
│                 │    │                 │    │                 │
│ • 用户界面       │◄──►│ • API路由       │◄──►│ • 通义千问 LLM  │
│ • 角色选择       │    │ • 业务逻辑      │    │ • 百度语音      │
│ • 对话界面       │    │ • 数据模型      │    │ • 阿里云OSS     │
│ • 状态管理       │    │ • 服务层        │    │ • Redis缓存     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐
                       │   数据存储      │
                       │                 │
                       │ • MySQL (持久化) │
                       │ • Redis (缓存)  │
                       └─────────────────┘
```

### 分层架构
```
┌─────────────────────────────────────────────────────────────┐
│                        表现层 (Presentation)                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   用户界面   │  │   角色选择   │  │   对话界面   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                        业务层 (Business)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   认证服务   │  │   对话服务   │  │   RAG服务   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                        数据层 (Data)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   MySQL     │  │    Redis    │  │   OSS存储   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 核心模块设计

### 前端模块架构

#### 模块结构
```
frontend/src/
├── components/          # 可复用组件
│   ├── AgentCard.vue   # 角色卡片组件
│   ├── aside.vue       # 侧边栏组件
│   └── nav.vue         # 导航组件
├── views/              # 页面组件
│   ├── AgentHall.vue  # 角色大厅
│   ├── Chat.vue       # 对话页面
│   ├── Login.vue      # 登录页面
│   └── UserCenter.vue # 用户中心
├── stores/             # 状态管理
│   ├── user.js        # 用户状态
│   └── counter.js     # 计数器状态
├── api/               # API接口
│   ├── api.js        # API配置
│   ├── axios.js      # HTTP客户端
│   ├── user.js       # 用户接口
│   └── chat.js       # 聊天接口
└── utils/             # 工具函数
    └── sessionId.js  # 会话ID管理
```

#### 组件职责
- **AgentCard**: 角色信息展示、选择交互
- **Chat**: 对话界面、消息显示、语音控制
- **Login**: 用户认证、表单验证
- **UserCenter**: 用户信息管理、设置配置

#### 状态管理
```javascript
// stores/user.js - 用户状态管理
export const useUserStore = defineStore('user', {
  state: () => ({
    token: localStorage.getItem('qny-token'),
    userInfo: null,
    isLoggedIn: false
  }),
  actions: {
    login(token, userInfo) {
      this.token = token;
      this.userInfo = userInfo;
      this.isLoggedIn = true;
      localStorage.setItem('qny-token', token);
    },
    logout() {
      this.token = null;
      this.userInfo = null;
      this.isLoggedIn = false;
      localStorage.removeItem('qny-token');
    }
  }
});
```

### 后端模块架构

#### 目录结构
```
backend/app/
├── core/               # 核心配置
│   ├── config.py      # 配置管理
│   ├── db.py          # 数据库连接
│   ├── security.py    # 安全认证
│   └── middleware.py  # 中间件
├── models/             # 数据模型
│   ├── user.py        # 用户模型
│   ├── role.py        # 角色模型
│   ├── chat.py        # 聊天模型
│   └── scene.py       # 场景模型
├── schemas/            # 数据验证
│   ├── auth.py        # 认证模式
│   ├── user.py        # 用户模式
│   ├── chat.py        # 聊天模式
│   └── role.py        # 角色模式
├── routers/            # API路由
│   ├── auth.py        # 认证路由
│   ├── chat.py        # 聊天路由
│   ├── role.py        # 角色路由
│   └── me.py          # 用户路由
├── services/           # 业务服务
│   ├── llm_service.py # LLM服务
│   ├── tts_service.py # 语音服务
│   ├── rag_service.py # RAG服务
│   └── user_service.py# 用户服务
└── utils/              # 工具函数
    ├── logger.py      # 日志工具
    └── helpers.py     # 辅助函数
```

#### 核心模块设计

##### 1. 认证授权模块 (`app/routers/auth.py`)
**负责人**: 赵愈炜

**功能职责**:
- JWT令牌生成和验证
- 用户注册和登录
- 权限控制和中间件
- 登录保护机制

**技术实现**:
```python
# JWT令牌管理
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

# 用户认证中间件
async def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=401,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    
    user = get_user(username)
    if user is None:
        raise credentials_exception
    return user
```

##### 2. 角色管理模块 (`app/routers/role.py`)
**负责人**: 麦尔旦·克热木

**功能职责**:
- 角色模板管理
- 角色搜索和获取
- 角色头像上传
- 自定义角色创建

**技术实现**:
```python
# 角色搜索服务
@router.get("/search")
async def search_roles(q: str = Query(..., min_length=1)):
    # 搜索内置角色
    builtin_roles = search_builtin_roles(q)
    
    # 搜索数据库中的自定义角色
    custom_roles = search_custom_roles(q)
    
    # 合并结果并去重
    all_roles = list(set(builtin_roles + custom_roles))
    
    return {"results": all_roles}

# 角色模板获取
@router.get("/template/{name}")
async def get_role_template(name: str):
    # 优先获取内置模板
    template = get_builtin_template(name)
    if not template:
        # 获取自定义模板
        template = get_custom_template(name)
    
    if not template:
        raise HTTPException(status_code=404, detail="Role template not found")
    
    return {"name": name, "template": template}
```

##### 3. 对话系统模块 (`app/routers/chat.py`)
**负责人**: 赵愈炜

**功能职责**:
- 文本对话处理
- 流式输出支持
- 语音转文字和文字转语音
- 对话历史管理

**技术实现**:
```python
# 文本对话处理
@router.post("/text")
async def chat_text(
    request: ChatRequest,
    current_user: User = Depends(get_current_user)
):
    # 获取角色模板
    template = get_role_template(request.role)
    
    # 获取短期记忆（Redis）
    short_memory = get_short_memory(current_user.id, request.conversation_id)
    
    # 执行RAG检索
    retrieved_docs = rag_service.search(request.content)
    
    # 构建完整Prompt
    full_prompt = build_prompt(template, short_memory, retrieved_docs, request.content)
    
    # 调用LLM生成回复
    response = await llm_service.generate_response(full_prompt)
    
    # 保存对话记录
    save_conversation(current_user.id, request.conversation_id, request.content, response)
    
    # 更新短期记忆
    update_short_memory(current_user.id, request.conversation_id, request.content, response)
    
    return {"role": "assistant", "content": response, "conversation_id": request.conversation_id}

# 流式对话处理
@router.post("/text/stream")
async def chat_text_stream(
    request: ChatRequest,
    current_user: User = Depends(get_current_user)
):
    async def generate():
        # 生成流式响应
        async for chunk in llm_service.generate_stream_response(full_prompt):
            yield f"data: {json.dumps({'content': chunk, 'conversation_id': request.conversation_id})}\n\n"
        
        yield f"data: {json.dumps({'done': True, 'conversation_id': request.conversation_id})}\n\n"
    
    return StreamingResponse(generate(), media_type="text/plain")
```

##### 4. RAG检索模块 (`app/routers/rag.py`)
**负责人**: 麦尔旦·克热木

**功能职责**:
- 文档索引管理
- 智能检索服务
- 知识增强处理
- 文档上传和解析

**技术实现**:
```python
# 文档索引服务
class RAGService:
    def __init__(self):
        self.index = {}  # 使用TF-IDF作为轻量级向量化
        self.documents = {}
    
    def upsert_documents(self, doc_ids: List[str], documents: List[str]):
        """更新文档索引"""
        for doc_id, doc_content in zip(doc_ids, documents):
            self.documents[doc_id] = doc_content
        
        # 重建TF-IDF索引
        self._rebuild_index()
    
    def search(self, query: str, top_k: int = 5) -> List[Dict]:
        """检索相关文档"""
        if not self.index:
            return []
        
        # 计算查询向量
        query_vector = self._compute_tfidf_vector(query)
        
        # 计算相似度
        similarities = []
        for doc_id, doc_vector in self.index.items():
            similarity = self._cosine_similarity(query_vector, doc_vector)
            similarities.append({
                "doc_id": doc_id,
                "text": self.documents[doc_id],
                "score": similarity
            })
        
        # 返回Top-K结果
        similarities.sort(key=lambda x: x["score"], reverse=True)
        return similarities[:top_k]
```

##### 5. 用户管理模块 (`app/routers/me.py`)
**负责人**: 赵愈炜

**功能职责**:
- 用户信息管理
- 个人设置
- 数据统计
- 用户偏好管理

## 🗄️ 数据库设计

### 数据模型关系图
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    Users    │    │ Conversations│   │Chat Messages│
│             │    │             │    │             │
│ • id        │◄──►│ • id        │◄──►│ • id        │
│ • username  │    │ • user_id   │    │ • conv_id   │
│ • email     │    │ • role      │    │ • content   │
│ • password  │    │ • title     │    │ • role      │
│ • created_at│    │ • created_at│    │ • created_at│
└─────────────┘    └─────────────┘    └─────────────┘
       │
       │
┌─────────────┐
│Role Templates│
│             │
│ • id        │
│ • name      │
│ • prompt    │
│ • avatar_url│
│ • created_at│
└─────────────┘
```

### 表结构设计

#### 用户表 (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 角色模板表 (role_templates)
```sql
CREATE TABLE role_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL,
    prompt TEXT NOT NULL,
    avatar_url VARCHAR(500),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 对话会话表 (conversations)
```sql
CREATE TABLE conversations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    role VARCHAR(100) NOT NULL,
    title VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 聊天消息表 (chat_messages)
```sql
CREATE TABLE chat_messages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    conversation_id INT NOT NULL,
    user_id INT NOT NULL,
    role ENUM('user', 'assistant') NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

## 🔄 数据流设计

### 对话流程
```
用户输入 → 前端验证 → API请求 → 认证验证 → 角色模板获取
    ↓
短期记忆获取 → RAG检索 → Prompt构建 → LLM调用 → 响应生成
    ↓
长期记忆存储 → 短期记忆更新 → 响应返回 → 前端显示
```

### 认证流程
```
用户登录 → 密码验证 → JWT生成 → Token返回 → 前端存储
    ↓
API请求 → Token验证 → 用户信息获取 → 权限检查 → 业务处理
```

### RAG检索流程
```
用户问题 → 查询向量化 → 文档相似度计算 → Top-K筛选
    ↓
相关文档获取 → 上下文构建 → LLM增强 → 最终回复
```

## 🛡️ 安全设计

### 认证安全
- **JWT令牌**: 使用HS256算法，设置合理过期时间
- **密码加密**: 使用bcrypt进行密码哈希
- **登录保护**: 实现登录失败次数限制和账户锁定

### 数据安全
- **SQL注入防护**: 使用SQLAlchemy ORM防止SQL注入
- **XSS防护**: 前端输入验证和输出转义
- **CSRF防护**: 使用CSRF令牌验证

### 接口安全
- **请求限流**: 使用Redis实现API限流
- **参数验证**: 使用Pydantic进行严格参数验证
- **错误处理**: 统一错误响应格式，避免信息泄露

## 📊 性能优化

### 缓存策略
- **Redis缓存**: 短期记忆、会话信息、热点数据
- **数据库缓存**: 查询结果缓存、连接池管理
- **前端缓存**: 静态资源缓存、API响应缓存

### 数据库优化
- **索引优化**: 为常用查询字段添加索引
- **查询优化**: 使用合适的JOIN和WHERE条件
- **分页查询**: 大数据量查询使用分页

### 应用优化
- **异步处理**: 使用FastAPI的异步特性
- **连接池**: 数据库和Redis连接池管理
- **资源管理**: 合理的内存和CPU使用

## 🔧 开发规范

### 代码规范
- **Python**: 遵循PEP 8规范，使用Black格式化
- **JavaScript**: 遵循ESLint规范，使用Prettier格式化
- **注释**: 关键函数和类必须添加文档字符串
- **命名**: 使用有意义的变量和函数名

### 接口规范
- **RESTful**: 遵循REST API设计原则
- **状态码**: 正确使用HTTP状态码
- **错误处理**: 统一的错误响应格式
- **版本控制**: API版本管理策略

### 数据库规范
- **命名**: 使用下划线命名法
- **索引**: 为查询字段添加适当索引
- **约束**: 设置必要的外键和唯一约束
- **迁移**: 使用数据库迁移管理表结构变更

## 👥 开发分工

### 前端开发 (史鑫)
**主要职责**:
- 用户界面设计和实现
- 组件库建设和维护
- 状态管理设计
- API接口集成
- 性能优化和用户体验

**技术栈**:
- Vue.js 3 + Composition API
- Element Plus UI组件库
- Pinia状态管理
- Axios HTTP客户端
- Vue Router路由管理

### 后端开发 (赵愈炜、麦尔旦·克热木)
**主要职责**:
- API接口设计和实现
- 数据库设计和优化
- 业务逻辑开发
- AI服务集成
- 系统安全和性能优化

**技术栈**:
- FastAPI Web框架
- SQLAlchemy ORM
- Pydantic数据验证
- JWT认证
- Redis缓存

## 🚀 部署架构

### 开发环境
```
开发者机器 → 本地数据库 → 本地Redis → 外部API服务
```

### 测试环境
```
测试服务器 → 测试数据库 → 测试Redis → 外部API服务
```

### 生产环境
```
负载均衡器 → 应用服务器集群 → 主从数据库 → Redis集群 → 外部API服务
```

## 📈 监控和运维

### 应用监控
- **性能监控**: 响应时间、吞吐量、错误率
- **业务监控**: 用户活跃度、对话质量、功能使用率
- **资源监控**: CPU、内存、磁盘、网络使用情况

### 日志管理
- **应用日志**: 使用结构化日志记录关键操作
- **访问日志**: Nginx访问日志分析
- **错误日志**: 异常和错误信息记录

### 备份策略
- **数据库备份**: 定期全量备份和增量备份
- **代码备份**: Git版本控制和代码仓库备份
- **配置备份**: 环境配置和部署脚本备份

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**维护人员**: 开发团队
